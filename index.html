<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>懐かし掲示板 BBS</title>
    <link rel="icon" href="favicon.ico">
    <link rel="stylesheet" href="styles.css">
    <script>

// Global Variables
// ==============================

/** @type {number} 表示中のページ番号 */
let currentPage = 1;

/** @type {number} 1ページ分として表示する投稿の件数・API レスポンス上は最大でこの件数 `+1` の投稿が返る (Next ボタンの表示制御のため) */
const postsPerPage = 100;

/** @type {number} デフォルトのページ番号 */
const defaultPage = 1;

/** @type {number} タイムゾーンのオフセット値 */
const timezoneOffset = (new Date().getTimezoneOffset() + 540) * 60000;


// Service Functions
// ==============================

/**
 * ページ番号を特定する・数値変換出来なかった場合は `null` とする
 * 
 * @param {string | null | undefined} paramPage ページ番号のパラメータ
 * @return {number | null} ページ番号、数値変換できなければ `null`
 */
const detectPage = (paramPage) => {
  if(paramPage == null || String(paramPage).trim() ==='') return null;
  const numParamPage = Number(paramPage);
  if(Number.isNaN(numParamPage)) return null;
  return Math.trunc(numParamPage);
};

/**
 * 日時文字列を JST に直し整形する
 * 
 * @param {string} dateString SQLite が管理する `YYYY-MM-DD HH:mm` 形式の文字列・UTC 想定
 * @return {string} `YYYY-MM-DD HH:mm` 形式の文字列・確実に JST に変換した値
 */
const convertToJst = (dateString) => {
  if(dateString == null || String(dateString).toString() === '') return '[ERROR]';
  const jstDate = new Date(new Date(dateString).getTime() + timezoneOffset);
  return               jstDate.getFullYear()
    + '-'    + ('0' + (jstDate.getMonth() + 1)).slice(-2)
    + '-'    + ('0' +  jstDate.getDate()      ).slice(-2)
    + '<br>' + ('0' +  jstDate.getHours()     ).slice(-2)
    + ':'    + ('0' +  jstDate.getMinutes()   ).slice(-2);
};

/**
 * HTML をサニタイズする
 * 
 * @param {string} value 文字列
 * @return {string} サニタイズした文字列
 */
const sanitize = (value) => value.replace((/&/g), '&amp;').replace((/</g), '&lt;').replace((/>/g), '&gt;').replace((/"/g), '&quot;');

/**
 * コメント文字列の改行を有効にする
 * 
 * @param {string} comment コメント文字列
 * @return {string} 改行コードを変換したコメント文字列
 */
const convertComment = (comment) => comment.replace((/\\n/g), '\n');

/**
 * 値を確実に文字列に変換する
 * 
 * @param {string | null | undefined} value 値
 * @return {string} `null`・`undefined` の場合は空文字・その他は `trim()` した値
 */
const convertToTrimmedString = (value) => (value == null) ? '' : String(value).trim();

/**
 * API から投稿を取得する
 * 
 * @param {number} paramPage 取得するページ番号・クエリ文字列の場合は `detectPage()` で正常値に変換済のモノを使用する
 * return { posts: Array<{ id: number; date: string; comment: string; count: number; rank: string; }>; page: number; } 投稿一覧と正しいページ番号
 */
const fetchPosts = async (paramPage) => {
  const getPostsUrl = new URL('/api/posts', location.origin);
  if(paramPage != null) getPostsUrl.search = new URLSearchParams({ page: paramPage });
  
  const getResponse = await fetch(getPostsUrl.toString());
  const getResponseJson = await getResponse.json();
  const posts = getResponseJson.posts;
  const page  = getResponseJson.page;
  return { posts, page};
};

/**
 * 投稿を出力する
 * 
 * @param {Array<{ id: number; date: string; comment: string; count: number; rank: string; }>} posts 投稿一覧
 * @param {number} page 正しいページ番号
 */
const showPosts = (posts, page, isPushState = false) => {
  // 表示件数より1件多くレスポンスされた場合
  const hasNext = posts.length >= postsPerPage + 1;
  
  // テーブルを出力する
  const tbody = document.getElementById('posts-tbody');
  if(posts.length === 0) {
    tbody.innerHTML = '<tr><td class="announce" colspan="6">投稿はありません</td></tr>';
  } else {
    if(hasNext) posts.pop();  // 表示件数より1件多かった場合は末尾の1件を削除する
    tbody.innerHTML = posts.map((post) => {
      if(post.name === 'Announce Bot') return `<tr><td class="column-id">${post.id}</td><td class="announce" colspan="5">${convertComment(sanitize(post.comment))}</td></tr>`;
      return `<tr>
        <td class="column-id"     >${post.id}</td>
        <td class="column-date"   >${convertToJst(post.date)}</td>
        <td class="column-name"   >${sanitize(post.name)}</td>
        <td class="column-comment">${convertComment(sanitize(post.comment))}</td>
        <td class="column-count"  >${post.count}回</td>
        <td class="column-rank"   >${post.rank}</td>
      </tr>`;
    }).join('');
  }
  
  // Push or Replace URL
  const validUrl = new URL(location.href);
  validUrl.search = new URLSearchParams(page === defaultPage ? {} : { page });
  history[isPushState ? 'pushState' : 'replaceState']({ page }, null, validUrl.toString());
  // Current Page
  currentPage = page;
  
  // Back ボタン
  const hasBack = page > defaultPage;
  document.getElementById('nav-back-button').style.display = hasBack ? 'inline' : 'none';
  // Next ボタン
  document.getElementById('nav-next-button').style.display = hasNext ? 'inline' : 'none';
};

/** 初期表示時の処理 */
const onFirstView = async () => {
  try {
    // Detect Param Page
    const rawParamPage = new URL(location.href).searchParams.get('page');
    const paramPage = detectPage(rawParamPage);
    
    // Fetch And Show
    const { posts, page } = await fetchPosts(paramPage);
    showPosts(posts, page);
    
    console.log('Get Posts', { rawParamPage, paramPage, page, posts });
  }
  catch(error) {
    console.error('Get Posts : Failed', error);
    document.getElementById('posts-tbody').innerHTML = '<tr><th colspan="6" class="announce">エラーが発生しました</th></tr>';
  }
};

/** 投稿時の処理 */
const onPost = async () => {
  const formError   = document.getElementById('form-error');
  const inputSubmit = document.getElementById('input-submit')
  try {
    // Validate
    formError.style.display = 'none';
    inputSubmit.disabled = true;
    const name    = convertToTrimmedString(document.getElementById('input-name'   ).value);
    const comment = convertToTrimmedString(document.getElementById('input-comment').value);
    if(name === '' || comment === '') throw new Error('Invalid Input');
    
    // Post
    const postUrl = new URL('/api/posts', location.origin).toString();
    const postResponse = await fetch(postUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, comment })
    });
    const postResponseJson = await postResponse.json();
    if(!postResponse.ok) {
      console.error('Post : Failed : Error Response',  { name, comment, postResponseJson });
      throw new Error('Error Response');
    }
    
    console.log('Post', { name, comment, postResponseJson });
    document.getElementById('input-comment').value = '';  // Reset
    document.getElementById('posts-tbody').innerHTML = '<tr><th colspan="6" class="announce">投稿完了・再読込中…</th></tr>';
    
    // Re-Show Latest Posts
    const { posts, page } = await fetchPosts(defaultPage);
    showPosts(posts, page, true);
  }
  catch(error) {
    console.error('Post : Failed', error);
    formError.style.display = 'block';
    formError.innerText = 'エラーが発生しました';
    inputSubmit.disabled = false;
  }
};

// Controllers
// ==============================

document.addEventListener('DOMContentLoaded', async () => {
  await onFirstView();
  
  // Header
  document.getElementById('button-home'       ).addEventListener('click', () => location.href = 'https://neos21.net/');
  document.getElementById('button-ranks'      ).addEventListener('click', () => location.href = '/ranks'             );
  document.getElementById('button-rank-titles').addEventListener('click', () => location.href = '/rank-titles'       );
  
  // Form
  const inputName    = document.getElementById('input-name'   );
  const inputComment = document.getElementById('input-comment');
  const inputSubmit  = document.getElementById('input-submit' );
  inputSubmit.disabled = true;  // Init
  document.getElementById('input-form').addEventListener('input', () => {
    inputSubmit.disabled = inputName.value.trim() === '' || inputComment.value.trim() === '';
  });
  inputSubmit.addEventListener('click', async (event) => {
    event.preventDefault();
    await onPost();
  });
  
  // Footer
  document.getElementById('nav-back-button').addEventListener('click', async () => {
    const { posts, page } = await fetchPosts(currentPage - 1);
    showPosts(posts, page, true);
  });
  document.getElementById('nav-next-button').addEventListener('click', async () => {
    const { posts, page } = await fetchPosts(currentPage + 1);
    showPosts(posts, page, true);
  });
  
  // Pop State
  window.addEventListener('popstate', async (event) => {
    const targetPage = event?.state?.page ?? defaultPage;
    const { posts, page } = await fetchPosts(targetPage);
    showPosts(posts, page);
  });
});

    </script>
  </head>
  <body>

<header>
  <div>
    <button type="button" id="button-home"       >HOME</button>
    <button type="button" id="button-ranks"      >ランキング</button>
    <button type="button" id="button-rank-titles">昇進資格説明</button>
  </div>
  <h1><span>懐かし掲示板 BBS</span></h1>
</header>

<form id="input-form">
  <div class="form-grid">
    <div style="grid-area: form-name">
      <label for="input-name">
        Name
        <input type="text" id="input-name" value="" placeholder="Name" size="12" maxlength="30">
      </label>
    </div>
    <div style="grid-area: form-comment">
      <textarea id="input-comment" placeholder="Message" cols="40" rows="4" maxlength="1000"></textarea>
    </div>
    <div style="grid-area: form-submit">
      <button type="submit" id="input-submit" disabled>送信</button>
    </div>
  </div>
  <p class="form-error" id="form-error"></p>
</form>

<main>
  <table class="posts-table">
    <thead>
      <tr>
        <th class="column-id"     >No</th>
        <th class="column-date"   >Date</th>
        <th class="column-name"   >Name</th>
        <th class="column-comment">Message</th>
        <th class="column-count"  >回数</th>
        <th class="column-rank"   >昇進状態</th>
      </tr>
    </thead>
    <tbody id="posts-tbody">
      <tr>
        <th colspan="6" class="announce">Loading...</th>
      </tr>
    </tbody>
  </table>
</main>

<footer>
  <button type="button" id="nav-back-button">Back</button>
  <button type="button" id="nav-next-button">Next</button>
</footer>

  </body>
</html>
